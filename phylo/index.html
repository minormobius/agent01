<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>phylo — tree of life browser — minomobi</title>
<style>
  * { margin: 0; box-sizing: border-box; }
  body { font: 14px/1.6 monospace; padding: 1em; background: #111; color: #ccc; }
  h1 { font-size: 1em; color: #888; margin-bottom: .5em; }
  #status { color: #666; margin-bottom: 1em; }

  #main { display: flex; gap: 0; }
  #tree { flex: 1; min-width: 0; overflow-x: auto; }

  ul { list-style: none; padding-left: 1.2em; }
  li { border-left: 1px solid #333; padding-left: .6em; margin: 2px 0; }
  .node-row { display: inline-flex; align-items: baseline; gap: .3em; }
  .name { cursor: pointer; }
  .name:hover { color: #fff; }
  .rank { color: #555; font-size: .85em; }
  .tips { color: #444; font-size: .85em; }
  .info-btn {
    cursor: pointer; font-size: .7em; color: #444; border: 1px solid #333;
    border-radius: 50%; width: 1.4em; height: 1.4em; display: inline-flex;
    align-items: center; justify-content: center; opacity: 0; transition: opacity .15s;
    vertical-align: middle; flex-shrink: 0;
  }
  .node-row:hover .info-btn { opacity: 1; }
  .info-btn:hover { color: #adf; border-color: #adf; }
  .collapsed > ul { display: none; }
  .collapsed > .node-row > .name::before { content: "▸ "; color: #555; }
  .expanded > .node-row > .name::before { content: "▾ "; color: #555; }
  .leaf > .node-row > .name::before { content: "· "; color: #333; }

  /* info panel */
  #info-panel {
    width: 0; overflow: hidden; transition: width .2s; border-left: 1px solid #222;
    flex-shrink: 0; background: #0d0d0d;
  }
  #info-panel.open { width: 320px; }
  #info-inner {
    width: 320px; padding: 1em; font-size: .9em; overflow-y: auto; max-height: calc(100vh - 4em);
  }
  #info-panel h2 { font-size: 1em; color: #ddd; margin-bottom: .2em; font-weight: normal; }
  #info-panel .info-rank { color: #777; font-size: .85em; margin-bottom: .8em; }
  #info-panel .info-section { margin-bottom: .8em; }
  #info-panel .info-label { color: #666; font-size: .8em; text-transform: uppercase; letter-spacing: .05em; margin-bottom: .3em; }
  #info-panel a {
    color: #8bf; text-decoration: none; display: block; padding: 3px 0;
    border-bottom: 1px solid #1a1a1a;
  }
  #info-panel a:hover { color: #adf; }
  #info-panel a::before { content: "↗ "; color: #444; }
  #info-panel .info-loading { color: #555; }
  #info-panel .info-close {
    cursor: pointer; color: #555; float: right; font-size: 1.2em; line-height: 1;
  }
  #info-panel .info-close:hover { color: #fff; }
  #info-panel .info-flags { color: #665; font-size: .8em; margin-top: .3em; }
  #info-panel .info-synonyms { color: #666; font-size: .85em; }
  #info-panel .info-synonyms span { color: #888; }
  #info-panel .iucn-badge {
    display: inline-block; font-size: .75em; padding: 1px 5px; border-radius: 3px;
    color: #111; font-weight: bold; margin-left: .4em; vertical-align: middle;
  }
  .iucn-LC { background: #4caf50; } .iucn-NT { background: #8bc34a; }
  .iucn-VU { background: #ff9800; } .iucn-EN { background: #f44336; }
  .iucn-CR { background: #b71c1c; color: #fff; } .iucn-EW { background: #555; color: #fff; }
  .iucn-EX { background: #000; color: #666; } .iucn-DD { background: #888; }
  #info-panel .info-img { margin-bottom: .8em; }
  #info-panel .info-img img {
    max-width: 100%; border-radius: 4px; border: 1px solid #222;
  }
</style>
</head>
<body>
<h1>phylo.minomobi.com <a href="zoom.html" style="color:#555;font-size:.85em;text-decoration:none;margin-left:.6em" title="zoom navigator">&rarr; zoom view</a></h1>
<div id="status">loading…</div>
<div id="main">
  <div id="tree"></div>
  <div id="info-panel"><div id="info-inner"></div></div>
</div>
<script>
const OTT_PRIMATES = 913935;
const API = "https://api.opentreeoflife.org/v3";
const infoCache = {};
const ozCache = {};
const IUCN_LABELS = {
  LC: "Least Concern", NT: "Near Threatened", VU: "Vulnerable",
  EN: "Endangered", CR: "Critically Endangered", EW: "Extinct in Wild",
  EX: "Extinct", DD: "Data Deficient"
};

async function fetchSubtree(ottId, heightLimit = -1) {
  const r = await fetch(`${API}/tree_of_life/subtree`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ node_id: `ott${ottId}`, format: "arguson", height_limit: heightLimit })
  });
  const d = await r.json();
  return d.arguson;
}

async function fetchTaxonInfo(ottId) {
  if (infoCache[ottId]) return infoCache[ottId];
  const r = await fetch(`${API}/taxonomy/taxon_info`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ ott_id: ottId, include_lineage: false })
  });
  const d = await r.json();
  infoCache[ottId] = d;
  return d;
}

async function fetchOneZoom(ottId) {
  if (ozCache[ottId]) return ozCache[ottId];
  try {
    const r = await fetch(`https://www.onezoom.org/API/otts2identifiers?key=0&otts=${ottId}`);
    const d = await r.json();
    const row = d && d[0] ? d[0] : {};
    ozCache[ottId] = row;
    return row;
  } catch { ozCache[ottId] = {}; return {}; }
}

function buildLinks(ottId, name, taxSources, oz) {
  const links = [];
  // Wikipedia via Wikidata (best), fallback to name
  if (oz && oz.wikidata) {
    links.push({ label: "Wikipedia", url: `https://www.wikidata.org/wiki/${oz.wikidata}`, cat: "reference" });
    links.push({ label: "Wikidata", url: `https://www.wikidata.org/wiki/${oz.wikidata}`, cat: "reference" });
  }
  // Try direct Wikipedia by name (reliable for most taxa)
  if (!oz || !oz.wikidata) {
    links.push({ label: "Wikipedia", url: `https://en.wikipedia.org/wiki/${encodeURIComponent(name)}`, cat: "reference" });
  } else {
    // Wikidata exists — build Wikipedia link from name too (Wikidata doesn't go straight to article)
    links.push({ label: "Wikipedia", url: `https://en.wikipedia.org/wiki/${encodeURIComponent(name)}`, cat: "reference" });
    // Remove the duplicate Wikidata-based Wikipedia entry
    links.splice(0, 1);
  }
  // Encyclopedia of Life
  if (oz && oz.eol) {
    links.push({ label: "Encyclopedia of Life", url: `https://eol.org/pages/${oz.eol}`, cat: "reference" });
  }
  // IUCN Red List
  if (oz && oz.iucn) {
    links.push({ label: "IUCN Red List", url: `https://www.iucnredlist.org/species/${oz.iucn}`, cat: "conservation" });
  }
  // OneZoom visualization
  links.push({ label: "OneZoom", url: `https://www.onezoom.org/life/@=${ottId}`, cat: "tree" });
  // Open Tree of Life
  links.push({ label: "Open Tree of Life", url: `https://tree.opentreeoflife.org/taxonomy/browse?id=${ottId}`, cat: "tree" });
  // Parse tax_sources from OTL
  for (const src of (taxSources || [])) {
    const [prefix, id] = src.split(":");
    switch (prefix) {
      case "ncbi":
        links.push({ label: "NCBI Taxonomy", url: `https://www.ncbi.nlm.nih.gov/Taxonomy/Browser/wwwtax.cgi?id=${id}`, cat: "database" });
        break;
      case "gbif":
        links.push({ label: "GBIF", url: `https://www.gbif.org/species/${id}`, cat: "database" });
        break;
      case "worms":
        links.push({ label: "WoRMS", url: `https://www.marinespecies.org/aphia.php?p=taxdetails&id=${id}`, cat: "database" });
        break;
      case "irmng":
        links.push({ label: "IRMNG", url: `https://www.irmng.org/aphia.php?p=taxdetails&id=${id}`, cat: "database" });
        break;
    }
  }
  return links;
}

function renderPanel(inner, ottId, name, rank, data, oz) {
  const links = buildLinks(ottId, data.name || name, data.tax_sources, oz);
  const synonyms = (data.synonyms || []).filter(s => s !== name);
  const flags = (data.flags || []).filter(f => f);
  const iucnCode = oz && oz.iucn ? (oz.iucn_code || null) : null;

  let html = `<span class="info-close">&times;</span>`;
  html += `<h2>${data.unique_name || data.name || name}`;
  if (iucnCode && IUCN_LABELS[iucnCode]) {
    html += ` <span class="iucn-badge iucn-${iucnCode}" title="${IUCN_LABELS[iucnCode]}">${iucnCode}</span>`;
  }
  html += `</h2>`;
  html += (data.rank && data.rank !== "no rank") ? `<div class="info-rank">${data.rank} · ott${ottId}</div>` : `<div class="info-rank">ott${ottId}</div>`;

  // Group links by category
  const cats = [
    { key: "reference", label: "Reference" },
    { key: "conservation", label: "Conservation" },
    { key: "tree", label: "Tree Browsers" },
    { key: "database", label: "Databases" }
  ];
  for (const cat of cats) {
    const catLinks = links.filter(l => l.cat === cat.key);
    if (catLinks.length === 0) continue;
    html += `<div class="info-section"><div class="info-label">${cat.label}</div>`;
    for (const lnk of catLinks) {
      html += `<a href="${lnk.url}" target="_blank" rel="noopener">${lnk.label}</a>`;
    }
    html += `</div>`;
  }

  if (synonyms.length > 0) {
    html += `<div class="info-section"><div class="info-label">Synonyms</div>`;
    html += `<div class="info-synonyms">${synonyms.map(s => `<span>${s}</span>`).join(", ")}</div></div>`;
  }
  if (flags.length > 0) {
    html += `<div class="info-section"><div class="info-flags">${flags.join(", ")}</div></div>`;
  }
  inner.innerHTML = html;
  inner.querySelector(".info-close").onclick = () => document.getElementById("info-panel").classList.remove("open");
}

function showInfoPanel(ottId, name, rank) {
  const panel = document.getElementById("info-panel");
  const inner = document.getElementById("info-inner");
  panel.classList.add("open");
  inner.innerHTML = `<span class="info-close">&times;</span><h2>${name}</h2>` +
    (rank && rank !== "no rank" ? `<div class="info-rank">${rank}</div>` : "") +
    `<div class="info-loading">fetching…</div>`;
  inner.querySelector(".info-close").onclick = () => panel.classList.remove("open");

  // Fetch OTL + OneZoom in parallel
  const pOtl = fetchTaxonInfo(ottId);
  const pOz = fetchOneZoom(ottId);

  pOtl.then(data => {
    // Render immediately with OTL data (OneZoom will enhance when ready)
    renderPanel(inner, ottId, name, rank, data, {});
    // Then enhance with OneZoom data
    pOz.then(oz => renderPanel(inner, ottId, name, rank, data, oz));
  }).catch(() => {
    inner.querySelector(".info-loading").textContent = "couldn't load info";
  });
}

function renderNode(node) {
  const li = document.createElement("li");
  const tax = node.taxon || {};
  const name = tax.name || node.node_id || "?";
  const rank = tax.rank || "";
  const tips = node.num_tips || 0;
  const kids = node.children || [];
  const ottId = tax.ott_id;

  const row = document.createElement("span");
  row.className = "node-row";

  const span = document.createElement("span");
  span.className = "name";
  span.textContent = name;
  row.appendChild(span);

  if (rank && rank !== "no rank") {
    const r = document.createElement("span");
    r.className = "rank";
    r.textContent = rank;
    row.appendChild(r);
  }
  if (tips > 0) {
    const t = document.createElement("span");
    t.className = "tips";
    t.textContent = `(${tips})`;
    row.appendChild(t);
  }

  if (ottId) {
    const btn = document.createElement("span");
    btn.className = "info-btn";
    btn.textContent = "i";
    btn.title = "taxon info & links";
    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      showInfoPanel(ottId, name, rank);
    });
    row.appendChild(btn);
  }

  li.appendChild(row);

  if (kids.length > 0) {
    const ul = document.createElement("ul");
    for (const child of kids) ul.appendChild(renderNode(child));
    li.appendChild(ul);
    li.className = "collapsed";
    span.addEventListener("click", () => {
      li.className = li.className === "collapsed" ? "expanded" : "collapsed";
    });
  } else {
    li.className = "leaf";
  }
  return li;
}

(async () => {
  const status = document.getElementById("status");
  const treeEl = document.getElementById("tree");
  try {
    status.textContent = "fetching primates from open tree of life…";
    const tree = await fetchSubtree(OTT_PRIMATES);
    const count = JSON.stringify(tree).length;
    status.textContent = `loaded (${(count / 1024).toFixed(0)} KB arguson)`;
    const ul = document.createElement("ul");
    ul.appendChild(renderNode(tree));
    treeEl.appendChild(ul);
  } catch (e) {
    status.textContent = `error: ${e.message}`;
  }
})();
</script>
</body>
</html>
