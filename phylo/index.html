<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>phylo — tree of life browser — minomobi</title>
<style>
  * { margin: 0; box-sizing: border-box; }
  body { font: 14px/1.6 monospace; padding: 1em; max-width: 60em; background: #111; color: #ccc; }
  h1 { font-size: 1em; color: #888; margin-bottom: .5em; }
  #status { color: #666; margin-bottom: 1em; }
  ul { list-style: none; padding-left: 1.2em; }
  li { border-left: 1px solid #333; padding-left: .6em; margin: 2px 0; }
  .name { cursor: pointer; }
  .name:hover { color: #fff; }
  .rank { color: #555; font-size: .85em; }
  .tips { color: #444; font-size: .85em; }
  .collapsed > ul { display: none; }
  .collapsed > .name::before { content: "▸ "; color: #555; }
  .expanded > .name::before { content: "▾ "; color: #555; }
  .leaf > .name::before { content: "· "; color: #333; }
</style>
</head>
<body>
<h1>phylo.minomobi.com</h1>
<div id="status">loading…</div>
<div id="tree"></div>
<script>
const OTT_PRIMATES = 913935;
const API = "https://api.opentreeoflife.org/v3";

async function fetchSubtree(ottId, heightLimit = -1) {
  const r = await fetch(`${API}/tree_of_life/subtree`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ node_id: `ott${ottId}`, format: "arguson", height_limit: heightLimit })
  });
  const d = await r.json();
  return d.arguson;
}

function renderNode(node) {
  const li = document.createElement("li");
  const tax = node.taxon || {};
  const name = tax.name || node.node_id || "?";
  const rank = tax.rank || "";
  const tips = node.num_tips || 0;
  const kids = node.children || [];

  const span = document.createElement("span");
  span.className = "name";
  span.textContent = name;
  li.appendChild(span);

  if (rank && rank !== "no rank") {
    const r = document.createElement("span");
    r.className = "rank";
    r.textContent = ` ${rank}`;
    li.appendChild(r);
  }
  if (tips > 0) {
    const t = document.createElement("span");
    t.className = "tips";
    t.textContent = ` (${tips})`;
    li.appendChild(t);
  }

  if (kids.length > 0) {
    const ul = document.createElement("ul");
    for (const child of kids) ul.appendChild(renderNode(child));
    li.appendChild(ul);
    li.className = "collapsed";
    span.addEventListener("click", () => {
      li.className = li.className === "collapsed" ? "expanded" : "collapsed";
    });
  } else {
    li.className = "leaf";
  }
  return li;
}

(async () => {
  const status = document.getElementById("status");
  const treeEl = document.getElementById("tree");
  try {
    status.textContent = "fetching primates from open tree of life…";
    const tree = await fetchSubtree(OTT_PRIMATES);
    const count = JSON.stringify(tree).length;
    status.textContent = `loaded (${(count / 1024).toFixed(0)} KB arguson)`;
    const ul = document.createElement("ul");
    ul.appendChild(renderNode(tree));
    treeEl.appendChild(ul);
  } catch (e) {
    status.textContent = `error: ${e.message}`;
  }
})();
</script>
</body>
</html>
