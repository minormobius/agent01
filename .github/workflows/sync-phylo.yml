name: Sync Phylo to ATProto

on:
  push:
    branches:
      - claude/atproto-tree-visualization-6QTyy
      - main
    paths:
      - 'scripts/sync-otol-to-atproto.py'
      - 'phylo/lexicons/**'
      - '.github/workflows/sync-phylo.yml'

  workflow_dispatch:
    inputs:
      mode:
        description: 'Sync mode'
        required: true
        default: 'full-sync'
        type: choice
        options:
          - full-sync
          - enrich-only
      ott_ids:
        description: 'Comma-separated OTT IDs to sync (244265=Mammalia, 81461=Aves)'
        required: false
        default: '244265,81461'
      height_limit:
        description: 'OToL API height limit (-1=unlimited, use 5-10 for large clades)'
        required: false
        default: '-1'
      chunk_size:
        description: 'Max nodes per clade record (default: 400)'
        required: false
        default: '400'
      force_enrich:
        description: 'Re-enrich all nodes even if they already have common names'
        required: false
        default: false
        type: boolean
      account:
        description: 'Bluesky account to write to'
        required: false
        default: 'main'
        type: choice
        options:
          - main
          - modulo
          - morphyx

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Enrich existing records with Wikidata common names
        if: inputs.mode == 'enrich-only'
        env:
          BLUESKY_HANDLE: ${{ secrets.BLUESKY_HANDLE }}
          BLUESKY_APP_PASSWORD: ${{ secrets.BLUESKY_APP_PASSWORD }}
          BLUESKY_MODULO_HANDLE: ${{ secrets.BLUESKY_MODULO_HANDLE }}
          BLUESKY_MODULO_APP_PASSWORD: ${{ secrets.BLUESKY_MODULO_APP_PASSWORD }}
          BLUESKY_MORPHYX_HANDLE: ${{ secrets.BLUESKY_MORPHYX_HANDLE }}
          BLUESKY_MORPHYX_APP_PASSWORD: ${{ secrets.BLUESKY_MORPHYX_APP_PASSWORD }}
        run: |
          python3 scripts/sync-otol-to-atproto.py \
            --enrich-only \
            ${{ inputs.force_enrich == 'true' && '--force-enrich' || '' }} \
            --account ${{ inputs.account || 'main' }} \
            2>&1 | tee phylo/sync-log.txt

      - name: Full sync from OToL to ATProto PDS
        if: inputs.mode != 'enrich-only'
        env:
          BLUESKY_HANDLE: ${{ secrets.BLUESKY_HANDLE }}
          BLUESKY_APP_PASSWORD: ${{ secrets.BLUESKY_APP_PASSWORD }}
          BLUESKY_MODULO_HANDLE: ${{ secrets.BLUESKY_MODULO_HANDLE }}
          BLUESKY_MODULO_APP_PASSWORD: ${{ secrets.BLUESKY_MODULO_APP_PASSWORD }}
          BLUESKY_MORPHYX_HANDLE: ${{ secrets.BLUESKY_MORPHYX_HANDLE }}
          BLUESKY_MORPHYX_APP_PASSWORD: ${{ secrets.BLUESKY_MORPHYX_APP_PASSWORD }}
        run: |
          # Sync each clade in the list
          OTT_IDS="${{ inputs.ott_ids || '244265,81461' }}"
          echo "Syncing clades: $OTT_IDS"
          > phylo/sync-log.txt
          IFS=',' read -ra IDS <<< "$OTT_IDS"
          for OTT in "${IDS[@]}"; do
            OTT=$(echo "$OTT" | tr -d ' ')
            echo "========== Syncing OTT $OTT ==========" | tee -a phylo/sync-log.txt
            python3 scripts/sync-otol-to-atproto.py \
              --ott-id "$OTT" \
              --height-limit ${{ inputs.height_limit || '-1' }} \
              --chunk-size ${{ inputs.chunk_size || '400' }} \
              --min-clade 50 \
              --replace \
              --account ${{ inputs.account || 'main' }} \
              2>&1 | tee -a phylo/sync-log.txt
            echo "" | tee -a phylo/sync-log.txt
          done

      - name: Commit sync log
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add phylo/sync-log.txt
          git diff --cached --quiet && echo "No log changes" || git commit -m "sync-phylo: sync log [auto]" && git push origin ${{ github.ref_name }}
