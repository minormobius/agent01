name: Sync Phylo to ATProto

on:
  push:
    branches:
      - claude/atproto-tree-visualization-6QTyy
      - main
    paths:
      - 'scripts/sync-otol-to-atproto.py'
      - 'phylo/lexicons/**'
      - '.github/workflows/sync-phylo.yml'

  workflow_dispatch:
    inputs:
      ott_id:
        description: 'OTT ID of root taxon (913935=Primates, 244265=Mammalia, 795941=Cephalopoda)'
        required: true
        default: '913935'
      height_limit:
        description: 'OToL API height limit (-1=unlimited, use 5-10 for large clades)'
        required: false
        default: '-1'
      chunk_size:
        description: 'Max nodes per clade record (default: 250)'
        required: false
        default: '250'
      account:
        description: 'Bluesky account to write to'
        required: false
        default: 'main'
        type: choice
        options:
          - main
          - modulo
          - morphyx

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Sync to ATProto PDS (adaptive chunking)
        env:
          BLUESKY_HANDLE: ${{ secrets.BLUESKY_HANDLE }}
          BLUESKY_APP_PASSWORD: ${{ secrets.BLUESKY_APP_PASSWORD }}
          BLUESKY_MODULO_HANDLE: ${{ secrets.BLUESKY_MODULO_HANDLE }}
          BLUESKY_MODULO_APP_PASSWORD: ${{ secrets.BLUESKY_MODULO_APP_PASSWORD }}
          BLUESKY_MORPHYX_HANDLE: ${{ secrets.BLUESKY_MORPHYX_HANDLE }}
          BLUESKY_MORPHYX_APP_PASSWORD: ${{ secrets.BLUESKY_MORPHYX_APP_PASSWORD }}
        run: |
          python3 scripts/sync-otol-to-atproto.py \
            --ott-id ${{ inputs.ott_id || '913935' }} \
            --height-limit ${{ inputs.height_limit || '-1' }} \
            --chunk-size ${{ inputs.chunk_size || '250' }} \
            --account ${{ inputs.account || 'main' }}

      - name: Verify clade records written
        env:
          BLUESKY_HANDLE: ${{ secrets.BLUESKY_HANDLE }}
        run: |
          # Resolve handle to DID
          DID=$(python3 -c "
          import json, urllib.request
          url = 'https://public.api.bsky.app/xrpc/com.atproto.identity.resolveHandle?handle=${{ secrets.BLUESKY_HANDLE }}'
          with urllib.request.urlopen(url) as r:
              print(json.loads(r.read())['did'])
          ")
          echo "DID: $DID"

          # Resolve PDS
          PDS=$(python3 -c "
          import json, urllib.request
          with urllib.request.urlopen('https://plc.directory/${DID}') as r:
              doc = json.loads(r.read())
          for svc in doc.get('service', []):
              if svc.get('type') == 'AtprotoPersonalDataServer':
                  print(svc['serviceEndpoint'])
                  break
          ")
          echo "PDS: $PDS"

          # Count clade records
          COUNT=$(python3 -c "
          import json, urllib.request
          total = 0
          cursor = ''
          while True:
              url = '${PDS}/xrpc/com.atproto.repo.listRecords?repo=${DID}&collection=com.minomobi.phylo.clade&limit=100'
              if cursor:
                  url += '&cursor=' + cursor
              with urllib.request.urlopen(url) as r:
                  data = json.loads(r.read())
              total += len(data.get('records', []))
              cursor = data.get('cursor', '')
              if not cursor or not data.get('records'):
                  break
          print(total)
          ")
          echo "âœ“ $COUNT phylo.clade records in repo"
