name: Sync Phylo to ATProto

on:
  push:
    branches:
      - claude/atproto-tree-visualization-6QTyy
      - main
    paths:
      - 'scripts/sync-otol-to-atproto.py'
      - 'phylo/lexicons/**'
      - '.github/workflows/sync-phylo.yml'

  workflow_dispatch:
    inputs:
      ott_id:
        description: 'OTT ID of root taxon (913935=Primates, 244265=Mammalia, 795941=Cephalopoda)'
        required: true
        default: '913935'
      height_limit:
        description: 'OToL API height limit (-1=unlimited, use 5-10 for large clades)'
        required: false
        default: '-1'
      chunk_size:
        description: 'Max nodes per clade record (default: 250)'
        required: false
        default: '250'
      account:
        description: 'Bluesky account to write to'
        required: false
        default: 'main'
        type: choice
        options:
          - main
          - modulo
          - morphyx

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Sync to ATProto PDS (adaptive chunking)
        env:
          BLUESKY_HANDLE: ${{ secrets.BLUESKY_HANDLE }}
          BLUESKY_APP_PASSWORD: ${{ secrets.BLUESKY_APP_PASSWORD }}
          BLUESKY_MODULO_HANDLE: ${{ secrets.BLUESKY_MODULO_HANDLE }}
          BLUESKY_MODULO_APP_PASSWORD: ${{ secrets.BLUESKY_MODULO_APP_PASSWORD }}
          BLUESKY_MORPHYX_HANDLE: ${{ secrets.BLUESKY_MORPHYX_HANDLE }}
          BLUESKY_MORPHYX_APP_PASSWORD: ${{ secrets.BLUESKY_MORPHYX_APP_PASSWORD }}
        run: |
          python3 scripts/sync-otol-to-atproto.py \
            --ott-id ${{ inputs.ott_id || '244265' }} \
            --height-limit ${{ inputs.height_limit || '-1' }} \
            --chunk-size ${{ inputs.chunk_size || '250' }} \
            --account ${{ inputs.account || 'main' }} \
            2>&1 | tee phylo/sync-log.txt

      - name: Commit sync log
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add phylo/sync-log.txt
          git diff --cached --quiet && echo "No log changes" || git commit -m "sync-phylo: sync log [auto]" && git push origin ${{ github.ref_name }}
