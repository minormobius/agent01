<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Density â€” The Mino Times</title>
    <link rel="stylesheet" href="assets/css/newspaper.css">
    <style>
        .density-tool {
            max-width: 640px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        .density-desc {
            font-family: 'Source Serif 4', serif;
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--gray);
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .handle-form {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .handle-form input {
            flex: 1;
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--light-rule);
            background: #fff;
            color: var(--ink);
            min-width: 0;
        }
        .handle-form input:focus {
            outline: none;
            border-color: var(--accent);
        }
        .handle-form button {
            font-family: 'Inter', sans-serif;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.5rem 1.25rem;
            border: 1px solid var(--ink);
            background: var(--ink);
            color: var(--paper);
            cursor: pointer;
            white-space: nowrap;
        }
        .handle-form button:hover {
            background: var(--accent);
            border-color: var(--accent);
        }
        .handle-form button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .filter-bar {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--light-rule);
        }
        .filter-btn {
            font-family: 'Inter', sans-serif;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.35rem 0.75rem;
            border: 1px solid var(--light-rule);
            background: transparent;
            color: var(--gray);
            cursor: pointer;
        }
        .filter-btn:hover {
            border-color: var(--ink);
            color: var(--ink);
        }
        .filter-btn.active {
            background: var(--ink);
            border-color: var(--ink);
            color: var(--paper);
        }
        .status-line {
            font-family: 'Inter', sans-serif;
            font-size: 0.75rem;
            color: var(--gray);
            margin-bottom: 1rem;
        }
        .status-line.error {
            color: var(--accent);
        }
        .progress-track {
            width: 100%;
            height: 2px;
            background: var(--light-rule);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.3s ease;
        }
        .results-header {
            font-family: 'Inter', sans-serif;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--accent);
            margin-bottom: 0.75rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid var(--light-rule);
        }
        .post-item {
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--light-rule);
        }
        .post-item:last-child {
            border-bottom: none;
        }
        .post-text {
            font-family: 'Source Serif 4', serif;
            font-size: 1.05rem;
            line-height: 1.5;
            color: var(--ink);
            margin-bottom: 0.35rem;
        }
        .post-meta {
            font-family: 'Inter', sans-serif;
            font-size: 0.65rem;
            color: var(--gray);
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .post-meta a {
            color: var(--accent);
            text-decoration: none;
        }
        .post-meta a:hover {
            text-decoration: underline;
        }
        .empty-state {
            font-family: 'Source Serif 4', serif;
            font-size: 0.95rem;
            color: var(--gray);
            text-align: center;
            padding: 3rem 1rem;
            font-style: italic;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header class="masthead">
        <div class="masthead-date"><a href="./" style="color: inherit; text-decoration: none;">The Mino Times</a></div>
        <h1 style="font-size: clamp(2rem, 5vw, 3.5rem);">Density</h1>
        <div class="masthead-tagline">Post brevity, measured</div>
        <hr class="masthead-rule">
    </header>

    <main class="density-tool">
        <p class="density-desc">
            Enter a Bluesky handle to surface their most potent short-form posts &mdash;
            filtered by exact word count and ranked by character length.
        </p>

        <form class="handle-form" id="handleForm">
            <input type="text" id="handleInput" placeholder="handle.bsky.social" autocomplete="off" spellcheck="false">
            <button type="submit" id="loadBtn">Load</button>
        </form>

        <div class="progress-track hidden" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="status-line hidden" id="status"></div>

        <div class="filter-bar hidden" id="filterBar">
            <button class="filter-btn active" data-n="3">3 words</button>
            <button class="filter-btn" data-n="4">4 words</button>
            <button class="filter-btn" data-n="5">5 words</button>
        </div>

        <div class="results-header hidden" id="resultsHeader"></div>
        <div id="results"></div>
    </main>

    <footer class="footer">
        <a href="./" style="color: var(--gray);">The Mino Times</a> &middot; <a href="https://time.minomobi.com" style="color: var(--gray);">time.minomobi.com</a>
    </footer>

    <script src="js/atproto.js"></script>
    <script>
    (function () {
        const POST_COLLECTION = 'app.bsky.feed.post';
        let allPosts = [];
        let currentHandle = '';
        let activeFilter = 3;

        // --- Utilities ---

        function cleanText(text) {
            return text
                .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')   // [text](url) -> text
                .replace(/https?:\/\/\S+/g, '')              // strip bare URLs
                .trim();
        }

        function countWords(text) {
            const clean = cleanText(text);
            if (!clean) return 0;
            return clean.split(/\s+/).filter(Boolean).length;
        }

        function charLength(text) {
            return cleanText(text).length;
        }

        function rkeyFrom(uri) {
            return uri.split('/').pop();
        }

        function escapeHtml(str) {
            const el = document.createElement('span');
            el.textContent = str;
            return el.innerHTML;
        }

        function shortDate(iso) {
            if (!iso) return '';
            const d = new Date(iso);
            return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        // --- Fetch all posts with pagination ---

        async function fetchAllPosts(handle, onProgress) {
            const { did, pds } = await resolveIdentity(handle);
            const posts = [];
            let cursor = undefined;

            do {
                const params = new URLSearchParams({
                    repo: did,
                    collection: POST_COLLECTION,
                    limit: '100'
                });
                if (cursor) params.set('cursor', cursor);

                let data;
                try {
                    const res = await fetch(
                        `https://public.api.bsky.app/xrpc/com.atproto.repo.listRecords?${params}`
                    );
                    if (!res.ok) throw new Error(res.status);
                    data = await res.json();
                } catch {
                    const res = await fetch(
                        `${pds}/xrpc/com.atproto.repo.listRecords?${params}`
                    );
                    if (!res.ok) throw new Error(`Could not fetch posts (${res.status})`);
                    data = await res.json();
                }

                if (data.records) posts.push(...data.records);
                cursor = data.cursor;
                if (onProgress) onProgress(posts.length);
            } while (cursor);

            return { posts, handle };
        }

        // --- Filter, sort, render ---

        function filterAndSort(posts, n) {
            return posts
                .filter(r => countWords(r.value?.text || '') === n)
                .sort((a, b) => charLength(b.value.text) - charLength(a.value.text));
        }

        function renderPosts(filtered, handle) {
            const results = document.getElementById('results');
            const header = document.getElementById('resultsHeader');

            if (filtered.length === 0) {
                header.classList.add('hidden');
                results.innerHTML = '<div class="empty-state">No posts found with this word count.</div>';
                return;
            }

            header.textContent = `${filtered.length} post${filtered.length !== 1 ? 's' : ''} \u00b7 ${activeFilter} words \u00b7 by character length`;
            header.classList.remove('hidden');

            results.innerHTML = filtered.map(r => {
                const text = r.value.text;
                const rkey = rkeyFrom(r.uri);
                const date = shortDate(r.value.createdAt);
                const chars = charLength(text);
                const bskyUrl = `https://bsky.app/profile/${encodeURIComponent(handle)}/post/${rkey}`;
                return `<div class="post-item">
                    <div class="post-text">${escapeHtml(text)}</div>
                    <div class="post-meta">
                        <span>${chars} chars</span>
                        <span>${date}</span>
                        <a href="${bskyUrl}" target="_blank" rel="noopener">view on Bluesky \u2197</a>
                    </div>
                </div>`;
            }).join('');
        }

        function setFilter(n) {
            activeFilter = n;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.n) === n);
            });
            renderPosts(filterAndSort(allPosts, n), currentHandle);
        }

        // --- Form handler ---

        document.getElementById('handleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const raw = document.getElementById('handleInput').value.trim().replace(/^@/, '');
            if (!raw) return;

            currentHandle = raw;
            const loadBtn = document.getElementById('loadBtn');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const status = document.getElementById('status');
            const filterBar = document.getElementById('filterBar');
            const resultsHeader = document.getElementById('resultsHeader');
            const results = document.getElementById('results');

            // Reset UI
            loadBtn.disabled = true;
            loadBtn.textContent = 'Loading\u2026';
            progressBar.classList.remove('hidden');
            progressFill.style.width = '0%';
            status.classList.remove('hidden', 'error');
            status.textContent = 'Resolving handle\u2026';
            filterBar.classList.add('hidden');
            resultsHeader.classList.add('hidden');
            results.innerHTML = '';

            // Update URL
            const url = new URL(window.location);
            url.searchParams.set('handle', raw);
            window.history.replaceState({}, '', url);

            try {
                const { posts } = await fetchAllPosts(raw, (count) => {
                    status.textContent = `Fetched ${count.toLocaleString()} posts\u2026`;
                    // Indeterminate-ish progress: asymptotic toward 95%
                    progressFill.style.width = Math.min(95, (1 - 1 / (1 + count / 200)) * 100) + '%';
                });

                allPosts = posts;
                progressFill.style.width = '100%';

                // Count how many match each filter
                const c3 = posts.filter(r => countWords(r.value?.text || '') === 3).length;
                const c4 = posts.filter(r => countWords(r.value?.text || '') === 4).length;
                const c5 = posts.filter(r => countWords(r.value?.text || '') === 5).length;
                status.textContent = `${posts.length.toLocaleString()} posts loaded \u00b7 3w: ${c3} \u00b7 4w: ${c4} \u00b7 5w: ${c5}`;

                filterBar.classList.remove('hidden');
                setFilter(activeFilter);
            } catch (err) {
                status.textContent = `Error: ${err.message}`;
                status.classList.add('error');
                progressFill.style.width = '0%';
            } finally {
                loadBtn.disabled = false;
                loadBtn.textContent = 'Load';
            }
        });

        // Filter button clicks
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => setFilter(parseInt(btn.dataset.n)));
        });

        // Auto-load from URL params
        const params = new URLSearchParams(location.search);
        const h = params.get('handle');
        if (h) {
            document.getElementById('handleInput').value = h;
            document.getElementById('handleForm').dispatchEvent(new Event('submit'));
        }
    })();
    </script>

</body>
</html>
